<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Desafio Estágio WEB 2024</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css"
      integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu"
      crossorigin="anonymous"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css"
      integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
  </head>
  <body class="bg-gray">
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container-fluid bg-blueberry">
        <img class="logo" src="logotipo.png" />
      </div>
    </nav>

    <div>
      <div class="container-fluid">
        <h2 class="gestao">Gestão de Verbas</h2>
      </div>

      <div class="container-fluid bg-white">
        <form>
          <div class="form-group row">
            <div class="col-md-3 form-group">
              <label for="selectAcao">Ação</label>
              <select name="selectAcao" id="selectAcao" class="form-control">
                <option value="" disabled selected hidden>
                  Selecione o tipo da ação...
                </option>
              </select>
            </div>

            <div class="col-md-3 form-group">
              <label for="inputDataPrevista">Data Prevista</label>
              <input type="date" class="form-control" id="inputDataPrevista" />
            </div>

            <div class="col-md-3 form-group">
              <label for="inputInvestimentoPrevisto"
                >Investimento Previsto</label
              >
              <div class="form-group input-group">
                <div class="input-group-addon">R$</div>
                <input
                  type="number"
                  class="form-control"
                  id="inputInvestimentoPrevisto"
                  placeholder="0,00"
                />
              </div>
            </div>

            <div class="col-md-3 form-group">
              <div class="col-md-6 form-group">
                <button
                  type="button"
                  class="btn btn-warning btn-block"
                  onclick="{clearInputs()}"
                >
                  <span
                    class="glyphicon glyphicon-erase"
                    aria-hidden="true"
                  ></span
                  >Limpar
                </button>
              </div>
              <div class="col-md-6 form-group">
                <button
                  type="button"
                  class="btn btn-success btn-block"
                  onclick="{postAcao()}"
                >
                  <span
                    class="glyphicon glyphicon-plus"
                    aria-hidden="true"
                  ></span
                  >Adicionar
                </button>
              </div>
            </div>
          </div>
        </form>

        <table
          id="myTable"
          class="display table table-striped table-bordered"
          style="width: 100%"
        >
          <thead>
            <tr>
              <th>Ação</th>
              <th>Data Prevista</th>
              <th>Investimento Previsto</th>
              <th class="text-center">Editar</th>
              <th>Excluir</th>
            </tr>
          </thead>
          <tbody id="TableTBody"></tbody>
        </table>
      </div>
    </div>

    <nav class="navbar navbar-default navbar-fixed-bottom">
      <div class="container-fluid bg-blueberry">
        <h4 class="footerText">
          © 2024 <strong>PHARMAVIEWS</strong>. Todos os direitos reservados.
        </h4>
      </div>
    </nav>
  </body>

  <script>
    const hoje = new Date();

    const dia = hoje.getDate(); // Dia do mês (1-31)
    const mes = hoje.getMonth() + 1; // Mês (0-11). Adiciona 1 porque os meses são indexados de 0.
    const ano = hoje.getFullYear(); // Ano (ex: 2024)

    // Formata o dia e o mês com dois dígitos
    const diaFormatado = dia < 10 ? `0${dia}` : dia;
    const mesFormatado = mes < 10 ? `0${mes}` : mes;

    // Formata a data como YYYY-MM-DD
    const dataFormatada = `${ano}-${mesFormatado}-${diaFormatado}`;

    const table = new DataTable("#myTable", {
      paging: false,
      info: false,
      searching: false,
      columnDefs: [
        { orderable: false, targets: 3 },
        { orderable: false, targets: 4 },
      ],
    });

    async function getTiposAcoes() {
      const response = await fetch("http://127.0.0.1:8000/tipos_acao/");
      const data = await response.json();

      Object.keys(data).map((option) => {
        const selectOption = document.createElement("option");
        selectOption.value = data[option].codigo_acao;
        selectOption.textContent = data[option].nome_acao;
        document.getElementById("selectAcao").appendChild(selectOption);
      });
    }
    getTiposAcoes();

    async function getAcoes() {
      const response = await fetch("http://127.0.0.1:8000/acoes/");
      const data = await response.json();

      data.forEach((row) => {
        table.row
          .add([
            row.tipo_acao.nome_acao,
            row.data_prevista,
            `R$ ${row.investimento}`,
            "<div class='text-center'><a><span class='glyphicon glyphicon-pencil blueIconTable'></span></a></div>",
            "<div class='text-center'><span class='glyphicon glyphicon-remove redIconTable'></span></a></div>",
          ])
          .draw(false);
      });
    }
    getAcoes();

    async function postAcao() {
      const postData = {
        codigo_acao: document.getElementById("selectAcao").value,
        data_prevista: document.getElementById("inputDataPrevista").value,
        data_cadastro: dataFormatada,
        investimento: document.getElementById("inputInvestimentoPrevisto")
          .value,
      };
      console.log(postData);

      try {
        const response = await fetch("http://127.0.0.1:8000/acao/", {
          method: "POST", // Método HTTP
          headers: {
            "Content-Type": "application/json", // Cabeçalho indicando que o corpo é um JSON
          },
          body: JSON.stringify(postData), // Converte o objeto JavaScript para JSON
        });

        if (!response.ok) {
          throw new Error("Erro na requisição: " + response.statusText);
        }

        const respostaJson = await response.json();
        console.log("Resposta do servidor:", respostaJson);
        location.reload();
      } catch (e) {
        console.error("Erro: ", e);
      }
    }

    function clearInputs() {
      document.getElementById("inputDataPrevista").value = "";
      document.getElementById("selectAcao").value = "";
      document.getElementById("inputInvestimentoPrevisto").value = "";
    }
  </script>
</html>
